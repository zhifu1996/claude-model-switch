#!/usr/bin/env python3
"""
Claude Code Model Switch
A CLI tool to quickly switch Claude Code default models.
Automatically fetches available models from CLIProxyAPI.
"""

import json
import urllib.request
import ssl
import os
import re
import sys
import shutil

# Configuration - Set these via environment variables
API_URL = os.environ.get("ANTHROPIC_BASE_URL", "https://api.example.com")
API_KEY = os.environ.get("ANTHROPIC_AUTH_TOKEN", "your-api-key-here")
CONFIG_FILE = os.path.expanduser("~/.bashrc")
SETTINGS_FILE = os.path.expanduser("~/.claude/settings.json")
TOOLS_DIR = os.path.expanduser("~/.claude/tools")
INSTALL_DIR = os.path.expanduser("~/.local/bin")
PROJECT_DIR = os.path.dirname(os.path.abspath(__file__))

# ANSI color codes
RED = '\033[0;31m'
GREEN = '\033[0;32m'
YELLOW = '\033[1;33m'
BLUE = '\033[0;34m'
CYAN = '\033[0;36m'
NC = '\033[0m'


def fetch_models():
    """Fetch available models from API"""
    print(f"{BLUE}Fetching available models...{NC}")

    url = f"{API_URL}/api/provider/claude/v1/models"
    req = urllib.request.Request(url, headers={
        'Authorization': f'Bearer {API_KEY}'
    })

    ctx = ssl.create_default_context()
    ctx.check_hostname = False
    ctx.verify_mode = ssl.CERT_NONE

    try:
        with urllib.request.urlopen(req, timeout=10, context=ctx) as response:
            data = json.loads(response.read().decode())
            return [m['id'] for m in data.get('data', [])]
    except Exception as e:
        print(f"{RED}Failed to fetch models: {e}{NC}")
        return []


def classify_models(models):
    """Classify and sort models alphabetically"""
    claude_models = sorted([m for m in models if any(x in m.lower() for x in
        ['claude', 'haiku', 'sonnet', 'opus', 'minimax'])])
    gemini_models = sorted([m for m in models if 'gemini' in m.lower() and m not in claude_models])
    other_models = sorted([m for m in models if m not in claude_models and m not in gemini_models])

    return claude_models, gemini_models, other_models


def get_current_config():
    """Get current configuration"""
    if not os.path.exists(CONFIG_FILE):
        return "", "", "", ""

    with open(CONFIG_FILE, 'r') as f:
        content = f.read()

    patterns = {
        'model': r'ANTHROPIC_MODEL\s*=\s*"?([^"\n]+)"?',
        'haiku': r'ANTHROPIC_DEFAULT_HAIKU_MODEL\s*=\s*"?([^"\n]+)"?',
        'opus': r'ANTHROPIC_DEFAULT_OPUS_MODEL\s*=\s*"?([^"\n]+)"?',
        'sonnet': r'ANTHROPIC_DEFAULT_SONNET_MODEL\s*=\s*"?([^"\n]+)"?',
    }

    result = {}
    for key, pattern in patterns.items():
        match = re.search(pattern, content)
        result[key] = match.group(1).strip() if match else ""

    return result['model'], result['haiku'], result['opus'], result['sonnet']


def clear_settings_model():
    """Clear model settings in ~/.claude/settings.json to allow env var priority"""
    if not os.path.exists(SETTINGS_FILE):
        return True

    try:
        with open(SETTINGS_FILE, 'r') as f:
            content = f.read()

        # Remove or comment out model-related lines
        patterns = [
            r'"model"\s*:\s*"[^"]*"',
            r'"defaultModel"\s*:\s*"[^"]*"',
        ]

        modified = False
        for pattern in patterns:
            if re.search(pattern, content):
                content = re.sub(pattern, 'null', content)
                modified = True

        if modified:
            with open(SETTINGS_FILE, 'w') as f:
                f.write(content)
            print(f"{YELLOW}Cleared model config in {SETTINGS_FILE}{NC}")

        return True
    except Exception as e:
        print(f"{RED}Failed to clear settings: {e}{NC}")
        return False


def refresh_env():
    """Refresh current shell environment by re-sourcing bashrc"""
    import subprocess
    try:
        result = subprocess.run(
            ['bash', '-c', 'source ~/.bashrc && env | grep ANTHROPIC'],
            capture_output=True, text=True
        )
        if result.returncode == 0:
            for line in result.stdout.strip().split('\n'):
                if '=' in line:
                    key, value = line.split('=', 1)
                    os.environ[key] = value
    except Exception as e:
        print(f"{YELLOW}Could not refresh environment: {e}{NC}")


def sync_to_install_dir():
    """Sync current script and uninstall.sh to ~/.local/bin"""
    script_path = os.path.abspath(__file__)
    script_dir = os.path.dirname(script_path)

    os.makedirs(INSTALL_DIR, exist_ok=True)

    # Copy main script as hidden file
    dest_script = os.path.join(INSTALL_DIR, ".claude-model-switch-bin")
    shutil.copy2(script_path, dest_script)
    os.chmod(dest_script, 0o755)
    print(f"{GREEN}Updated: {dest_script}{NC}")

    # Copy uninstall script if exists
    uninstall_src = os.path.join(script_dir, "uninstall.sh")
    if os.path.exists(uninstall_src):
        uninstall_dest = os.path.join(INSTALL_DIR, "claude-model-switch-uninstall")
        shutil.copy2(uninstall_src, uninstall_dest)
        os.chmod(uninstall_dest, 0o755)
        print(f"{GREEN}Updated: {uninstall_dest}{NC}")

    # Update Claude Code tools (regenerate with new paths)
    install_claude_tools()

    print(f"\n{GREEN}Sync complete!{NC}")
    return True


def install_claude_tools():
    """Install Claude Code tools configuration to ~/.claude/tools"""
    # Get the path to the script
    script_path = os.path.abspath(sys.argv[0])
    if script_path.endswith('/'):
        script_path = script_path[:-1]

    # Create tools directory if it doesn't exist
    os.makedirs(TOOLS_DIR, exist_ok=True)

    # Tool definitions
    tools = {
        "model-list.json": {
            "name": "model-list",
            "description": "List all available models with index numbers",
            "command": ["bash", "-c", f"{script_path} --list"]
        },
        "model.json": {
            "name": "model",
            "description": "Switch model by index number",
            "parameters": {
                "type": "object",
                "properties": {
                    "index": {"type": "integer", "description": "Model index number (see /model-list)"}
                },
                "required": ["index"]
            },
            "command": ["bash", "-c", f"{script_path} ${{index}}"]
        }
    }

    installed = []
    for filename, tool in tools.items():
        filepath = os.path.join(TOOLS_DIR, filename)
        with open(filepath, 'w') as f:
            json.dump(tool, f, indent=2)
        installed.append(filepath)

    print(f"{GREEN}Installed {len(installed)} Claude Code tools:{NC}")
    for path in installed:
        print(f"  - {path}")
    print(f"{YELLOW}Please restart Claude Code to use the new tools.{NC}")
    return True


def update_model(model, config_type="all"):
    """Update configuration"""
    if not os.path.exists(CONFIG_FILE):
        print(f"{RED}Config file not found: {CONFIG_FILE}{NC}")
        return False

    with open(CONFIG_FILE, 'r') as f:
        content = f.read()

    updates = {
        'main': ('ANTHROPIC_MODEL', model),
        'haiku': ('ANTHROPIC_DEFAULT_HAIKU_MODEL', model),
        'opus': ('ANTHROPIC_DEFAULT_OPUS_MODEL', model),
        'sonnet': ('ANTHROPIC_DEFAULT_SONNET_MODEL', model),
    }

    config_map = {
        "all": ['main', 'haiku', 'opus', 'sonnet'],
        "main": ['main'],
        "haiku": ['haiku'],
        "opus": ['opus'],
        "sonnet": ['sonnet'],
    }

    for key in config_map.get(config_type, ['main']):
        var_name, value = updates[key]
        pattern = rf'^export {var_name}\s*=\s*"?[^"\n]+"?'
        replacement = f'export {var_name}="{value}"'
        if re.search(pattern, content, re.MULTILINE):
            content = re.sub(pattern, replacement, content, flags=re.MULTILINE)

    with open(CONFIG_FILE, 'w') as f:
        f.write(content)

    # Clear settings.json to ensure env var priority
    clear_settings_model()
    # Refresh current process environment
    refresh_env()

    return True


def strip_ansi(text):
    """Remove ANSI escape codes"""
    return re.sub(r'\x1B\[[0-9;]*[mK]', '', text)


def print_two_columns(items, current_model, start_idx):
    """Display model list in two columns"""
    if not items:
        return start_idx

    # Calculate column width dynamically
    max_len = 0
    for i, item in enumerate(items):
        num = start_idx + i
        item_str = f"{num}. {item}"
        max_len = max(max_len, len(item_str))

    col_width = max_len + 4
    rows = (len(items) + 1) // 2

    for i in range(rows):
        left_idx = i
        right_idx = i + rows if i + rows < len(items) else None

        left = items[left_idx]
        left_is_selected = (left == current_model)
        if left_is_selected:
            left_str = f"{GREEN}{start_idx + left_idx}. {left} *{NC}"
        else:
            left_str = f"{start_idx + left_idx}. {left}"

        if right_idx is not None:
            right = items[right_idx]
            right_is_selected = (right == current_model)
            if right_is_selected:
                right_str = f"{GREEN}{start_idx + right_idx}. {right} *{NC}"
            else:
                right_str = f"{start_idx + right_idx}. {right}"
            # Pad with spaces to align, preserving color
            print(left_str + " " * (col_width - len(strip_ansi(left_str))) + right_str)
        else:
            if left_is_selected:
                print(f"{GREEN}{start_idx + left_idx}. {left} *{NC}")
            else:
                print(left_str)

    return start_idx + len(items)


def show_menu(claude_models, gemini_models, other_models, config):
    """Display menu"""
    print("\n" + GREEN + "=" * 60 + NC)
    print(GREEN + "           Claude Code Model Switch" + NC)
    print(GREEN + "=" * 60 + NC)
    print("")
    print(f"{YELLOW}API: {API_URL}{NC}")
    print("")
    print(f"{YELLOW}Current Configuration:{NC}")
    print(f"  Main Model (ANTHROPIC_MODEL):       {config[0] or 'Not Set'}")
    print(f"  Haiku Model:                        {config[1] or 'Not Set'}")
    print(f"  Opus Model:                         {config[2] or 'Not Set'}")
    print(f"  Sonnet Model:                       {config[3] or 'Not Set'}")
    print("")

    idx = 1

    if claude_models:
        print(f"{BLUE}--- Claude/Minimax Compatible ({len(claude_models)}) ---{NC}")
        idx = print_two_columns(claude_models, config[0], idx)
        print("")

    if gemini_models:
        print(f"{BLUE}--- Google Gemini Models ({len(gemini_models)}) ---{NC}")
        idx = print_two_columns(gemini_models, config[0], idx)
        print("")

    if other_models:
        print(f"{BLUE}--- Other Models ({len(other_models)}) ---{NC}")
        idx = print_two_columns(other_models, config[0], idx)
        print("")

    print(f"{CYAN}--- Set Individual Models ---{NC}")
    print("  [h] Set Haiku Model          [o] Set Opus Model")
    print("  [s] Set Sonnet Model         [m] Set Main Model (ANTHROPIC_MODEL)")
    print("")
    print(f"{CYAN}--- Batch Operations ---{NC}")
    print("  [a] Custom model name input")
    print("  [r] Sync all models to main model")
    print("  [q] Quit")
    print("")


def main():
    if not sys.version_info >= (3, 7):
        print(f"{RED}Python 3.7+ required{NC}")
        sys.exit(1)

    all_models = fetch_models()
    if not all_models:
        print(f"{RED}Failed to fetch models, exiting{NC}")
        sys.exit(1)

    claude_models, gemini_models, other_models = classify_models(all_models)
    config = get_current_config()

    print(f"{GREEN}Found {len(all_models)} models{NC}")

    while True:
        show_menu(claude_models, gemini_models, other_models, config)
        choice = input("Enter option: ").strip()

        if choice.isdigit() and 1 <= int(choice) <= (len(claude_models) + len(gemini_models) + len(other_models)):
            idx = int(choice) - 1
            all_model_list = claude_models + gemini_models + other_models
            selected_model = all_model_list[idx]
            print(f"\nSelected model: {selected_model}")
            print("  [1] Set Main Model (ANTHROPIC_MODEL)")
            print("  [2] Set Haiku Model")
            print("  [3] Set Opus Model")
            print("  [4] Set Sonnet Model")
            print("  [5] Set All Models")
            sub_choice = input("Choose: ").strip()

            config_map = {
                "1": "main", "2": "haiku", "3": "opus", "4": "sonnet", "5": "all"
            }
            if sub_choice in config_map:
                if update_model(selected_model, config_map[sub_choice]):
                    type_name = {"main": "Main Model", "haiku": "Haiku", "opus": "Opus", "sonnet": "Sonnet", "all": "All Models"}
                    print(f"{GREEN}Set {type_name[config_map[sub_choice]]} to: {selected_model}{NC}")
            config = get_current_config()

        elif choice.lower() == 'h':
            selected = select_model_menu(claude_models, gemini_models, other_models, "Haiku")
            if selected and update_model(selected, "haiku"):
                print(f"{GREEN}Set Haiku Model to: {selected}{NC}")
                config = get_current_config()

        elif choice.lower() == 'o':
            selected = select_model_menu(claude_models, gemini_models, other_models, "Opus")
            if selected and update_model(selected, "opus"):
                print(f"{GREEN}Set Opus Model to: {selected}{NC}")
                config = get_current_config()

        elif choice.lower() == 's':
            selected = select_model_menu(claude_models, gemini_models, other_models, "Sonnet")
            if selected and update_model(selected, "sonnet"):
                print(f"{GREEN}Set Sonnet Model to: {selected}{NC}")
                config = get_current_config()

        elif choice.lower() == 'm':
            selected = select_model_menu(claude_models, gemini_models, other_models, "Main")
            if selected and update_model(selected, "main"):
                print(f"{GREEN}Set Main Model to: {selected}{NC}")
                config = get_current_config()

        elif choice.lower() == 'a':
            print("\nAvailable configs: main, haiku, opus, sonnet, all")
            custom_model = input("Enter model name: ").strip()
            config_target = input("Set to which config (Enter for all): ").strip().lower()
            if not config_target:
                config_target = "all"
            if custom_model and config_target in ["main", "haiku", "opus", "sonnet", "all"]:
                if update_model(custom_model, config_target):
                    print(f"{GREEN}Set to: {custom_model}{NC}")
                config = get_current_config()

        elif choice.lower() == 'r':
            if config[0]:
                if update_model(config[0], "all"):
                    print(f"{GREEN}Synced all models to main model: {config[0]}{NC}")
                config = get_current_config()
            else:
                print(f"{RED}Main model not set{NC}")

        elif choice.lower() == 'q':
            print("Goodbye!")
            break

        else:
            print(f"{RED}Invalid option{NC}")

        input("\nPress Enter to continue...")


def select_model_menu(claude_models, gemini_models, other_models, target_name):
    """Model selection submenu"""
    print(f"\n{target_name} Model Selection:")
    all_models = claude_models + gemini_models + other_models
    for idx, model in enumerate(all_models, 1):
        print(f"  {idx}. {model}")
    print("  [q] Back")
    choice = input("Choose: ").strip()
    if choice.isdigit() and 1 <= int(choice) <= len(all_models):
        return all_models[int(choice) - 1]
    return None


def list_models_json():
    """List all models in JSON format for Claude Code tools"""
    all_models = fetch_models()
    if not all_models:
        print('{"error": "Failed to fetch models"}')
        return

    result = {"models": [{"id": m} for m in all_models]}
    print(json.dumps(result))


def switch_model_by_index(index):
    """Switch model by index number"""
    all_models = fetch_models()
    if not all_models:
        print(f'{{"error": "Failed to fetch models"}}')
        return

    try:
        idx = int(index)
        if idx < 1 or idx > len(all_models):
            print(f'{{"error": "Invalid index. Available range: 1-{len(all_models)}"}}')
            return

        selected_model = all_models[idx - 1]
        if update_model(selected_model, "all"):
            print(json.dumps({
                "success": True,
                "model": selected_model,
                "message": f"Model switched to {selected_model}. Please restart Claude Code to apply changes."
            }))
    except ValueError:
        print('{"error": "Invalid index. Please provide a number."}')


def main():
    # Check for command line arguments
    if len(sys.argv) > 1:
        arg = sys.argv[1]

        if arg in ['--list', '-l', '--list-json']:
            list_models_json()
            return

        if arg.isdigit():
            switch_model_by_index(arg)
            return

        # Update/sync to install directory
        if arg in ['--update', '-u', '--sync']:
            print(f"{BLUE}Syncing scripts to {INSTALL_DIR}...{NC}")
            sync_to_install_dir()
            return

        # Help
        if arg in ['--help', '-h']:
            print("Usage: claude-model-switch [OPTIONS] [INDEX]")
            print("")
            print("Options:")
            print("  -l, --list         List all models (JSON format)")
            print("  -u, --update       Sync scripts to ~/.local/bin")
            print("  INDEX              Switch to model by index number")
            print("  -h, --help         Show this help message")
            print("")
            print("For auto environment refresh, use 'model-switch' wrapper")
            print("(installed via install.sh)")
            return

    # Interactive mode
    if not sys.version_info >= (3, 7):
        print(f"{RED}Python 3.7+ required{NC}")
        sys.exit(1)

    # Auto-install Claude Code tools if not present
    model_list_tool = os.path.join(TOOLS_DIR, "model-list.json")
    model_tool = os.path.join(TOOLS_DIR, "model.json")
    if not (os.path.exists(model_list_tool) and os.path.exists(model_tool)):
        print(f"{YELLOW}Installing Claude Code tools...{NC}")
        install_claude_tools()
        print("")

    all_models = fetch_models()
    if not all_models:
        print(f"{RED}Failed to fetch models, exiting{NC}")
        sys.exit(1)

    claude_models, gemini_models, other_models = classify_models(all_models)
    config = get_current_config()

    print(f"{GREEN}Found {len(all_models)} models{NC}")

    while True:
        show_menu(claude_models, gemini_models, other_models, config)
        choice = input("Enter option: ").strip()

        if choice.isdigit() and 1 <= int(choice) <= (len(claude_models) + len(gemini_models) + len(other_models)):
            idx = int(choice) - 1
            all_model_list = claude_models + gemini_models + other_models
            selected_model = all_model_list[idx]
            print(f"\nSelected model: {selected_model}")
            print("  [1] Set Main Model (ANTHROPIC_MODEL)")
            print("  [2] Set Haiku Model")
            print("  [3] Set Opus Model")
            print("  [4] Set Sonnet Model")
            print("  [5] Set All Models")
            sub_choice = input("Choose: ").strip()

            config_map = {
                "1": "main", "2": "haiku", "3": "opus", "4": "sonnet", "5": "all"
            }
            if sub_choice in config_map:
                if update_model(selected_model, config_map[sub_choice]):
                    type_name = {"main": "Main Model", "haiku": "Haiku", "opus": "Opus", "sonnet": "Sonnet", "all": "All Models"}
                    print(f"{GREEN}Set {type_name[config_map[sub_choice]]} to: {selected_model}{NC}")
            config = get_current_config()

        elif choice.lower() == 'h':
            selected = select_model_menu(claude_models, gemini_models, other_models, "Haiku")
            if selected and update_model(selected, "haiku"):
                print(f"{GREEN}Set Haiku Model to: {selected}{NC}")
                config = get_current_config()

        elif choice.lower() == 'o':
            selected = select_model_menu(claude_models, gemini_models, other_models, "Opus")
            if selected and update_model(selected, "opus"):
                print(f"{GREEN}Set Opus Model to: {selected}{NC}")
                config = get_current_config()

        elif choice.lower() == 's':
            selected = select_model_menu(claude_models, gemini_models, other_models, "Sonnet")
            if selected and update_model(selected, "sonnet"):
                print(f"{GREEN}Set Sonnet Model to: {selected}{NC}")
                config = get_current_config()

        elif choice.lower() == 'm':
            selected = select_model_menu(claude_models, gemini_models, other_models, "Main")
            if selected and update_model(selected, "main"):
                print(f"{GREEN}Set Main Model to: {selected}{NC}")
                config = get_current_config()

        elif choice.lower() == 'a':
            print("\nAvailable configs: main, haiku, opus, sonnet, all")
            custom_model = input("Enter model name: ").strip()
            config_target = input("Set to which config (Enter for all): ").strip().lower()
            if not config_target:
                config_target = "all"
            if custom_model and config_target in ["main", "haiku", "opus", "sonnet", "all"]:
                if update_model(custom_model, config_target):
                    print(f"{GREEN}Set to: {custom_model}{NC}")
                config = get_current_config()

        elif choice.lower() == 'r':
            if config[0]:
                if update_model(config[0], "all"):
                    print(f"{GREEN}Synced all models to main model: {config[0]}{NC}")
                config = get_current_config()
            else:
                print(f"{RED}Main model not set{NC}")

        elif choice.lower() == 'q':
            print("Goodbye!")
            break

        else:
            print(f"{RED}Invalid option{NC}")

        input("\nPress Enter to continue...")


if __name__ == "__main__":
    main()
